@page "/business"
@inject IBusinessService BusinessService
@inject IDialogService DialogService
@inject ISnackbar Snackbar
@using CP.Shared.DTOs
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Roles = "Admin")]

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudTable Items="@_businesses" Hover="true" Breakpoint="Breakpoint.Sm" Loading="@_loading" LoadingProgressColor="Color.Info">
        <ToolBarContent>
            <MudText Typo="Typo.h6">Gestión Global de Negocios</MudText>
            <MudSpacer />
        </ToolBarContent>
        <HeaderContent>
            <MudTh>Imagen</MudTh>
            <MudTh>Nombre</MudTh>
            <MudTh>Dueño</MudTh>
            <MudTh>Estado</MudTh>
            <MudTh>Creado</MudTh>
            <MudTh>Acciones</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="Imagen">
                @if (!string.IsNullOrEmpty(context.ImageUrl))
                {
                    <MudImage Src="@context.ImageUrl" Width="50" Height="50" ObjectFit="ObjectFit.Cover" Class="rounded-lg"/>
                }
                else
                {
                   <MudIcon Icon="@Icons.Material.Filled.Store" Size="Size.Large" />
                }
            </MudTd>
            <MudTd DataLabel="Nombre">@context.Name</MudTd>
            <MudTd DataLabel="Dueño">@context.UserId</MudTd>
            <MudTd DataLabel="Estado">
                @if(context.IsActive)
                {
                    <MudChip T="string" Color="Color.Success" Size="Size.Small">Activo</MudChip>
                }
                else
                {
                    <MudChip T="string" Color="Color.Error" Size="Size.Small">Inactivo</MudChip>
                }
            </MudTd>
            <MudTd DataLabel="Creado">@context.CreatedAt.ToShortDateString()</MudTd>
            <MudTd DataLabel="Acciones">
                <MudTooltip Text="@(context.IsActive ? "Dar de baja" : "Aprobar")">
                    <MudIconButton Icon="@(context.IsActive ? Icons.Material.Filled.Block : Icons.Material.Filled.CheckCircle)" 
                                   Color="@(context.IsActive ? Color.Error : Color.Success)" 
                                   OnClick="@(() => ToggleBusinessStatus(context))" />
                </MudTooltip>
            </MudTd>
        </RowTemplate>
    </MudTable>
</MudContainer>

@code {
    private List<BusinessDto> _businesses = new();
    private bool _loading = true;

    protected override async Task OnInitializedAsync()
    {
        await LoadBusinesses();
    }

    private async Task LoadBusinesses()
    {
        _loading = true;
        _businesses = await BusinessService.GetAllAsync();
        _loading = false;
    }

    private async Task ToggleBusinessStatus(BusinessDto business)
    {
        string action = business.IsActive ? "Dar de baja" : "Aprobar";
        bool? result = await DialogService.ShowMessageBox(
            $"{action} Negocio", 
            $"¿Estás seguro/a de que deseas {action.ToLower()} el negocio '{business.Name}'?", 
            yesText: action, cancelText: "Cancelar");

        if(result == true)
        {
            var updateDto = new UpdateBusinessDto
            {
                Id = business.Id,
                Name = business.Name,
                IsActive = !business.IsActive
            };

            var success = await BusinessService.UpdateAsync(business.Id, updateDto, null);
            if (success)
            {
                Snackbar.Add($"Negocio {(business.IsActive ? "desactivado" : "aprobado")} con éxito", Severity.Success);
                await LoadBusinesses();
            }
            else
            {
                Snackbar.Add("Error al cambiar el estado del negocio", Severity.Error);
            }
        }
    }
}
